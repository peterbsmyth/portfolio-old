function getUrlParameter(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}}function addDays(a,b){var c=new Date(a);return c.setDate(a.getDate()+b),c}Date.prototype.toJSONLocal=function(){function a(a){return(10>a?"0":"")+a}return this.getFullYear()+"-"+a(this.getMonth()+1)+"-"+a(this.getDate())},Date.prototype.toDateInputValue=function(){var a=new Date(this);return a.setMinutes(this.getMinutes()-this.getTimezoneOffset()),a.toJSON().slice(0,10)},Date.prototype.toDatetimeInputValue=function(){var a=new Date(this);return a.setMinutes(this.getMinutes()-this.getTimezoneOffset()),a.toJSON().slice(0,19)},Date.prototype.toHoursDotMinutes=function(){var a=this.getMinutes()/60,b=this.getHours();return b+a},Date.prototype.toDurationFormat=function(){var a=this.getHours(),b=this.getMinutes();return a+":"+b},Date.prototype.toChartDurationFormat=function(){var a=this.getHours(),b=this.getMinutes();return a+" Hrs "+b+" Mins"};var makeUTCDate=function(a){var b=new Date(a);return new Date(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate(),b.getUTCHours(),b.getUTCMinutes())};Date.prototype.addMinutes=function(a){return new Date(this.getTime()+6e4*a)};var durationToMinutes=function(a){var b=60*parseInt(a.substr(0,2),10),c=parseInt(a.substr(3,2),10);return b+c},datetimeFormat=function(a){var b,c,d,e=a;return b=e.substr(5,2)+"/"+e.substr(8,2)+"/"+e.substr(0,4)+" ",c=parseInt(e.substr(11,2),10),d=e.substr(14,2),c>12?(c-=12,b+=c+":"+d+" PM"):b+=0==c?"12:"+d+" AM":12==c?c+":"+d+" PM":c+":"+d+" AM"};String.prototype.toDateFormat=function(){return this.substr(5,2)+"/"+this.substr(8,2)+"/"+this.substr(0,4)};var pillar,datetime,duration,quality,notes,buildTable=function(a){var b=a,c=b+"T23:59:59";$.getJSON("functions.php",{content:"today",startDay:b,endDay:c},function(a){var b=$("#dayTable TBODY");b.empty(),a.forEach(function(a){var c=$("<tr>").attr("id",a.id),d=$("<td>").addClass("edit");$("<a href='#'></a>").addClass("okay glyphicon glyphicon-pencil").appendTo(d),$("<a href='#'></a>").addClass("cancel glyphicon glyphicon-remove").hide().appendTo(d),c.append(d);var e=$("<td>").html(a.pillar).addClass("pillar");c.append(e);var f=$("<td>").html(datetimeFormat(a.event_date)).addClass("datetime");c.append(f);var g=$("<td>").html(a.duration).addClass("duration");c.append(g);var h=$("<td>").html(a.quality).addClass("quality");c.append(h);var i=$("<td>").html(a.notes).addClass("notes");c.append(i),b.append(c)}),$("#dayTable").trigger("update")})},buildSummary=function(a,b){var a=a,b=b;$.getJSON("functions.php",{content:"summary",startSummary:a,endSummary:b},function(a){var b=$("#summaryTable TBODY");b.empty(),a.forEach(function(a){var c=$("<tr>").attr("id",a.id),d=$("<td>").addClass("edit");$("<a href='#'></a>").addClass("okay glyphicon glyphicon-pencil").appendTo(d),$("<a href='#'></a>").addClass("cancel glyphicon glyphicon-remove").hide().appendTo(d),c.append(d);var e=$("<td>").html(a.event_date.toDateFormat()).addClass("date");c.append(e);var f=$("<td>").html(a.quality).addClass("quality");c.append(f);var g=$("<td>").html(a.notes).addClass("notes");c.append(g),b.append(c)}),$("#summaryTable").trigger("update")})};$("#single-entry").on("submit",function(a){a.preventDefault(),$("#addEntryModal").modal("hide");var b=$(this).serialize()+"&content=newEntry";$.ajax({type:"POST",url:"functions.php",data:b,dataType:"json",success:function(a){var b=$("<tr>").attr("id",a.id),c=$("<td>").addClass("edit");$("<a href='#'></a>").addClass("okay glyphicon glyphicon-pencil").appendTo(c),$("<a href='#'></a>").addClass("cancel glyphicon glyphicon-remove").hide().appendTo(c),b.append(c);var d=$("<td>").html(a.pillar).addClass("pillar");b.append(d);var e=$("<td>").html(datetimeFormat(a.event_date)).addClass("datetime");b.append(e);var f=$("<td>").html(a.duration).addClass("duration");b.append(f);var g=$("<td>").html(a.quality).addClass("quality");b.append(g);var h=$("<td>").html(a.notes).addClass("notes");b.append(h),$("#dayTable TBODY").append(b),$("#dayTable").trigger("update")}})}),$("#summary-entry").on("submit",function(a){a.preventDefault(),$("#addSummaryModal").modal("hide");var b=$(this).serialize()+"&content=newSummary";$.ajax({type:"POST",url:"functions.php",data:b,dataType:"json",success:function(a){var b=$("<tr>").attr("id",a.id),c=$("<td>").addClass("edit");$("<a href='#'></a>").addClass("okay glyphicon glyphicon-pencil").appendTo(c),$("<a href='#'></a>").addClass("cancel glyphicon glyphicon-remove").hide().appendTo(c),b.append(c);var d=$("<td>").html(a.event_date.toDateFormat()).addClass("date");b.append(d);var e=$("<td>").html(a.quality).addClass("quality");b.append(e);var f=$("<td>").html(a.notes).addClass("notes");b.append(f),$("#summaryTable TBODY").append(b),$("#summaryTable").trigger("update")}})}),$("#dayTable").on("click",".okay",function(){var a=$(this).closest("tr");a.toggleClass("editMode");var b=a.hasClass("editMode");if(b){a.find("a").first().toggleClass("glyphicon-pencil glyphicon-ok"),a.find("a").last().show(),pillar=a.children(".pillar").html(),datetime=a.children(".datetime").html(),datetime=new Date(datetime).toDatetimeInputValue(),duration=a.children(".duration").html(),quality=a.children(".quality").html(),notes=a.children(".notes").html();var c=$("#pillar").clone().addClass("form-control input-sm");c.children("option[value='"+pillar+"']").attr("selected","selected");var d=$("<input>").attr("value",datetime).addClass("form-control input-sm").attr("type","datetime-local"),e=$("<input>").attr("value",duration).addClass("form-control input-sm").attr("type","text"),f=$("#quality").clone().addClass("form-control input-sm").css("display","initial");f.children("option[value='"+quality+"']").attr("selected","selected");var g=$("<input>").attr("value",notes).addClass("form-control input-sm").attr("type","text");a.children(".pillar").empty().append(c),a.children(".datetime").empty().append(d),a.children(".duration").empty().append(e),a.children(".quality").empty().append(f),a.children(".notes").empty().append(g)}else{var h=a.attr("id"),i=a.children(".pillar").children().val(),j=encodeURIComponent(a.children(".datetime").children().val()),k=encodeURIComponent(a.children(".duration").children().val()),l=a.children(".quality").children().val(),m=encodeURIComponent(a.children(".notes").children().val()),n="user_id="+h+"&user_pillar="+i+"&user_date="+j+"&user_duration="+k+"&user_quality="+l+"&user_notes="+m+"&content=updateEntry";a.find("a").first().toggleClass("glyphicon-pencil glyphicon-ok"),a.find("a").last().hide(),console.log(n),$.ajax({type:"POST",url:"functions.php",data:n,dataType:"json",success:function(a){$("#"+a.id).children(".pillar").replaceWith("<td class='pillar'>"+a.pillar+"</td>"),$("#"+a.id).children(".datetime").replaceWith("<td class='datetime'>"+datetimeFormat(a.event_date)+"</td>"),$("#"+a.id).children(".duration").replaceWith("<td class='duration'>"+a.duration+"</td>"),$("#"+a.id).children(".quality").replaceWith("<td class='quality'>"+a.quality+"</td>"),$("#"+a.id).children(".notes").replaceWith("<td class='notes'>"+a.notes+"</td>"),$("#dayTable").trigger("update")}})}}),$("#dayTable").on("click",".cancel",function(){var a=$(this).closest("tr");a.toggleClass("editMode"),$(this).siblings().toggleClass("glyphicon-pencil glyphicon-ok"),$(this).hide(),a.children(".pillar").replaceWith("<td class='pillar'>"+pillar+"</td>"),a.children(".datetime").replaceWith("<td class='datetime'>"+datetimeFormat(datetime)+"</td>"),a.children(".duration").replaceWith("<td class='duration'>"+duration+"</td>"),a.children(".quality").replaceWith("<td class='quality'>"+quality+"</td>"),a.children(".notes").replaceWith("<td class='notes'>"+notes+"</td>")}),$("#summaryTable").on("click",".okay",function(){var a=$(this).closest("tr");a.toggleClass("editMode");var b=a.hasClass("editMode");if(b){a.find("a").first().toggleClass("glyphicon-pencil glyphicon-ok"),a.find("a").last().show(),date=a.children(".date").html(),date=new Date(date).toDateInputValue(),quality=a.children(".quality").html(),notes=a.children(".notes").html();var c=$("<input>").attr("value",date).addClass("form-control input-sm").attr("type","date"),d=$("#quality").clone().addClass("form-control input-sm").css("display","initial");d.children("option[value='"+quality+"']").attr("selected","selected");var e=$("<input>").attr("value",notes).addClass("form-control input-sm").attr("type","text");a.children(".date").empty().append(c),a.children(".quality").empty().append(d),a.children(".notes").empty().append(e)}else{var f=a.attr("id"),g=encodeURIComponent(a.children(".date").children().val()),h=a.children(".quality").children().val(),i=encodeURIComponent(a.children(".notes").children().val()),j="user_id="+f+"&user_date="+g+"&user_quality="+h+"&user_notes="+i+"&content=updateSummary";a.find("a").first().toggleClass("glyphicon-pencil glyphicon-ok"),a.find("a").last().hide(),$.ajax({type:"POST",url:"functions.php",data:j,dataType:"json",success:function(a){console.log(a),$("#"+a.id).children(".date").replaceWith("<td class='date'>"+a.event_date.toDateFormat()+"</td>"),$("#"+a.id).children(".quality").replaceWith("<td class='quality'>"+a.quality+"</td>"),$("#"+a.id).children(".notes").replaceWith("<td class='notes'>"+a.notes+"</td>"),$("#summaryTable").trigger("update")}})}}),$("#summaryTable").on("click",".cancel",function(){var a=$(this).closest("tr");a.toggleClass("editMode"),$(this).siblings().toggleClass("glyphicon-pencil glyphicon-ok"),$(this).hide(),a.children(".date").replaceWith("<td class='date'>"+date.toDateFormat()+"</td>"),a.children(".quality").replaceWith("<td class='quality'>"+quality+"</td>"),a.children(".notes").replaceWith("<td class='notes'>"+notes+"</td>")});var today=new Date(Date.now());today.setDate(today.getDate()-6);var startChart=today.toJSONLocal(),setTitle=function(a){var b=a,c=makeUTCDate(b);return c=addDays(c,6).toJSONLocal(),"Pillars For "+a.toDateFormat()+" - "+c.toDateFormat()},buildChart=function(a){var b=a,c=makeUTCDate(b);c=addDays(c,6).toJSONLocal()+"T23:59:59";var d={content:"pillarsLog",startDay:b,endDay:c};$.ajax({type:"GET",url:"functions.php",data:d,dataType:"json",success:function(a){var b=a[0].event_date.substr(0,10),c=0,d=makeUTCDate("1990-09-13T00:00:00"),e=makeUTCDate("1990-09-13T00:00:00"),f=makeUTCDate("1990-09-13T00:00:00"),g=makeUTCDate("1990-09-13T00:00:00"),h=makeUTCDate("1990-09-13T00:00:00"),i=makeUTCDate("1990-09-13T00:00:00"),j=makeUTCDate("1990-09-13T00:00:00"),k=[];a.forEach(function(a){a.event_date.substr(0,10)===b?(c++,"ZAZEN"===a.pillar?d=d.addMinutes(durationToMinutes(a.duration)):"WORK"===a.pillar?e=e.addMinutes(durationToMinutes(a.duration)):"SOCIAL"===a.pillar?f=f.addMinutes(durationToMinutes(a.duration)):"LEARN"===a.pillar?g=g.addMinutes(durationToMinutes(a.duration)):"BIKE"===a.pillar?h=h.addMinutes(durationToMinutes(a.duration)):"EAT WELL"===a.pillar?i=i.addMinutes(durationToMinutes(a.duration)):"SLACK"===a.pillar&&(j=j.addMinutes(durationToMinutes(a.duration)))):(k.push({date:makeUTCDate(b),events:c,duration:{zazen:d,work:e,social:f,learn:g,bike:h,eatwell:i,slack:j}}),c=1,b=a.event_date.substr(0,10),d=makeUTCDate("1990-09-13T00:00:00"),e=makeUTCDate("1990-09-13T00:00:00"),f=makeUTCDate("1990-09-13T00:00:00"),g=makeUTCDate("1990-09-13T00:00:00"),h=makeUTCDate("1990-09-13T00:00:00"),i=makeUTCDate("1990-09-13T00:00:00"),j=makeUTCDate("1990-09-13T00:00:00"),"ZAZEN"===a.pillar?d=d.addMinutes(durationToMinutes(a.duration)):"WORK"===a.pillar?e=e.addMinutes(durationToMinutes(a.duration)):"SOCIAL"===a.pillar?f=f.addMinutes(durationToMinutes(a.duration)):"LEARN"===a.pillar?g=g.addMinutes(durationToMinutes(a.duration)):"BIKE"===a.pillar?h=h.addMinutes(durationToMinutes(a.duration)):"EAT WELL"===a.pillar?i=i.addMinutes(durationToMinutes(a.duration)):"SLACK"===a.pillar&&(j=j.addMinutes(durationToMinutes(a.duration))))}),k.push({date:makeUTCDate(b),events:c,duration:{zazen:d,work:e,social:f,learn:g,bike:h,eatwell:i,slack:j}}),k.forEach(function(a){for(var b in a.duration)a.duration[b+"hDM"]=a.duration[b].toHoursDotMinutes()});var l={top:20,right:30,bottom:30,left:40},m=970-l.left-l.right,n=530-l.top-l.bottom,o=k[0].date,p=k[k.length-1].date,q=d3.time.scale.utc().range([0,m]);q.domain(k.length<7?[o,d3.time.day.utc.offset(p,1+(7-k.length))]:[o,d3.time.day.utc.offset(p,1)]);var r=d3.scale.linear().domain([0,24]).range([0,n]),s=d3.svg.axis().orient("top").ticks(d3.time.days,1).tickFormat(d3.time.format("%a, %m/%d")).scale(q),t=d3.svg.axis().orient("left").ticks(24).scale(r),u=m/k.length;k.length<7&&(u=m/(k.length+(7-k.length)));var v=d3.scale.ordinal().range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"]);v.domain(d3.keys(k[0].duration).filter(function(a){return-1===a.indexOf("hDM")})),k.forEach(function(a){var b=0;a.duration.pillars=v.domain().map(function(c){return{name:c,y0:b,y1:b+=+a.duration[c+"hDM"],duration:a.duration[c]}}),a.total=a.duration.pillars[a.duration.pillars.length-1].y1});var w=d3.select(".chart").attr("width",m+l.left+l.right).attr("height",n+l.top+l.bottom).append("g").attr("transform","translate("+l.left+","+l.top+")");w.append("g").attr("class","x axis").attr("transform","translate(0,-1)").call(s),w.append("g").attr("class","y axis").attr("transform","translate(-1,0)").call(t).append("text").attr("transform","rotate(-90)").attr("y",6).attr("x",-455).attr("dy",".71em").style("text-anchor","end").text("Hours");var x=w.selectAll(".dateBar").data(k).enter().append("g").attr("class","g").attr("transform",function(a){return"translate("+q(a.date)+",0)"});x.selectAll("rect").data(function(a){return a.duration.pillars}).enter().append("rect").attr("width",u-1).attr("y",function(a){return r(a.y0)}).attr("height",function(a){return r(a.y1)-r(a.y0)}).style("fill",function(a){return v(a.name)}).on("mouseover",function(a){d3.select(this).style("fill","orange"),w.append("text").attr("id","tooltip").attr("x",450).attr("y",n).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","15px").attr("font-weight","bold").attr("fill","black").text("Pillar: "+a.name+" Duration: "+a.duration.toChartDurationFormat())}).on("mouseout",function(a){d3.select(this).transition().duration(250).style("fill",function(a){return v(a.name)}),d3.select("#tooltip").remove()});var y=w.selectAll(".legend").data(v.domain()).enter().append("g").attr("class","legend").attr("transform",function(a,b){return"translate(0,"+20*b+")"});y.append("rect").attr("x",m-18).attr("y",350).attr("width",18).attr("height",18).style("fill",v),y.append("text").attr("x",m-24).attr("y",359).attr("dy",".35em").style("text-anchor","end").text(function(a){return a}),$(".x.axis").children("g").last().remove()},error:function(a,b,c){console.log("error"),console.log(a),console.log(b),console.log(c)}})};buildChart(startChart),$("#datePicker").val(today.toDateInputValue()),$("#chart-title").text(setTitle(today.toDateInputValue())),$("#back7").on("click",function(){today.setDate(today.getDate()-7);var a=today.toJSONLocal();$("svg").empty(),$("#chart-title").text(setTitle(a)),buildChart(a)}),$("#back1").on("click",function(){today.setDate(today.getDate()-1);var a=today.toJSONLocal();$("svg").empty(),$("#chart-title").text(setTitle(a)),buildChart(a)}),$("#forward1").on("click",function(){today.setDate(today.getDate()+1);var a=today.toJSONLocal();$("svg").empty(),$("#chart-title").text(setTitle(a)),buildChart(a)}),$("#forward7").on("click",function(){today.setDate(today.getDate()+7);var a=today.toJSONLocal();$("svg").empty(),$("#chart-title").text(setTitle(a)),buildChart(a)}),$("body").on("change","#datePicker",function(){console.log("Updating Table...");var a=$(this).val();buildTable(a)}),$("#dayTable").tablesorter({headers:{0:{sorter:!1}}}),$("#datePicker").val((new Date).toDateInputValue());var startToday=new Date(Date.now()).toJSONLocal();buildTable(startToday),$("body").on("click","#add-entry",function(){if($("#dayTable TBODY").children().is("tr")){var a=$("#dayTable TBODY tr").last().children("td[class='datetime']").text(),b=$("#dayTable TBODY tr").last().children("td[class='duration']").text(),c=new Date(a);c=c.addMinutes(durationToMinutes(b)),$("#date").val(c.toDatetimeInputValue()),$("#duration").val("")}else $("#date").val($("#datePicker").val()+"T00:00:00")}),$("body").on("click","#go",function(){console.log("Updating Table...");var a=$("#startSummaryPicker").val(),b=$("#endSummaryPicker").val();buildSummary(a,b)}),$("#summaryTable").tablesorter({headers:{0:{sorter:!1}}}),$("#endSummaryPicker, #date").val((new Date).toDateInputValue());var startSummary=new Date;startSummary.setDate(startSummary.getDate()-6),$("#startSummaryPicker").val(startSummary.toDateInputValue());var today=new Date(Date.now()),endSummary=today.toJSONLocal();today.setDate(today.getDate()-6);var startSummary=today.toJSONLocal();buildSummary(startSummary,endSummary);